'use strict';var bun_sqlite=require('bun:sqlite');var a=class{constructor(t=":memory:"){this.currentQuery="";this.currentParams=[];this.schemas=new Map,this.db=new bun_sqlite.Database(t),this.db.exec("PRAGMA foreign_keys = ON");}close(){this.db.close();}defineSchema(t){this.schemas.set(t.name,t);let r=this.generateCreateTableSQL(t);if(this.db.exec(r),t.indexes)for(let e of t.indexes){let u=`CREATE ${e.unique?"UNIQUE":""} INDEX IF NOT EXISTS ${e.name} ON ${t.name} (${e.columns.join(", ")})`;this.db.exec(u);}for(let e of t.columns)if(e&&typeof e=="object"&&"_type"in e&&e._type==="index"){let s=e,n=`CREATE ${s.unique?"UNIQUE":""} INDEX IF NOT EXISTS ${s.name} ON ${t.name} (${s.columns.join(", ")})`;this.db.exec(n);}}getSchema(t){return this.schemas.get(t)}listTables(){return this.db.query("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'").all().map(r=>r.name)}dropTable(t){this.db.exec(`DROP TABLE IF EXISTS ${t}`),this.schemas.delete(t);}query(){return this.reset(),this.createQueryBuilder()}find(t,r){let e=Object.entries(r).map(([s,u])=>({column:s,operator:"=",value:u}));return this.query().select().from(t).where(e).execute()}findOne(t,r){return this.query().select().from(t).where(Object.entries(r).map(([e,s])=>({column:e,operator:"=",value:s}))).limit(1).executeOne()}findById(t,r){return this.findOne(t,{id:r})}all(t){return this.query().select().from(t).execute()}insert(t,r){this.query().insert(t,r).execute();let e=this.db.query("SELECT last_insert_rowid() as id").get();return this.findById(t,e.id)}update(t,r,e){return this.query().update(t,e).where({column:"id",operator:"=",value:r}).execute(),this.findById(t,r)}delete(t,r){return this.query().delete(t).where({column:"id",operator:"=",value:r}).execute(),true}transaction(t){this.db.exec("BEGIN TRANSACTION");try{t(this),this.db.exec("COMMIT");}catch(r){throw this.db.exec("ROLLBACK"),r}}exec(t){this.db.exec(t);}raw(t,r=[]){return this.db.query(t).all(...r)}rawOne(t,r=[]){return this.db.query(t).get(...r)}reset(){this.currentQuery="",this.currentParams=[];}createQueryBuilder(){let t={_select:["*"],_from:"",_where:[],_orderBy:"",_limit:null,_offset:null,_isInsert:false,_isUpdate:false,_isDelete:false,_insertData:null,_updateData:null},r=this;return t.select=function(e){return this._select=e||["*"],this},t.from=function(e){return this._from=e,this},t.where=function(e){let u=(Array.isArray(e)?e:[e]).map(n=>{if(n.operator==="IS NULL"||n.operator==="IS NOT NULL")return `${n.column} ${n.operator}`;if(n.operator==="IN"&&Array.isArray(n.value)){let o=n.value.map(()=>"?").join(", ");return n.value.forEach(l=>{r.currentParams.push(l);}),`${n.column} IN (${o})`}else return r.currentParams.push(n.value),`${n.column} ${n.operator} ?`});return this._where.push(...u),this},t.and=function(e){return this.where(e)},t.or=function(e){let s="";if(e.operator==="IS NULL"||e.operator==="IS NOT NULL")s=`${e.column} ${e.operator}`;else if(e.operator==="IN"&&Array.isArray(e.value)){let u=e.value.map(()=>"?").join(", ");e.value.forEach(n=>{r.currentParams.push(n);}),s=`${e.column} IN (${u})`;}else r.currentParams.push(e.value),s=`${e.column} ${e.operator} ?`;return this._where.push(`OR ${s}`),this},t.orderBy=function(e,s="ASC"){return this._orderBy=`ORDER BY ${e} ${s}`,this},t.limit=function(e){return this._limit=e,this},t.offset=function(e){return this._offset=e,this},t.insert=function(e,s){return this._isInsert=true,this._from=e,this._insertData=s,this},t.update=function(e,s){return this._isUpdate=true,this._from=e,this._updateData=s,this},t.delete=function(e){return this._isDelete=true,this._from=e,this},t.raw=function(e,s=[]){return r.currentQuery=e,r.currentParams=s,this},t.execute=function(){let e="";if(this._isInsert&&this._insertData){let n=Object.keys(this._insertData),o=Object.values(this._insertData);if(n.length===0)e=`INSERT INTO ${this._from} DEFAULT VALUES`,r.currentParams=[];else {let l=n.map(()=>"?").join(", ");e=`INSERT INTO ${this._from} (${n.join(", ")}) VALUES (${l})`,r.currentParams=o;}}else if(this._isUpdate&&this._updateData){let n=Object.keys(this._updateData).map(l=>`${l} = ?`),o=Object.values(this._updateData);if(r.currentParams=[...o,...r.currentParams],e=`UPDATE ${this._from} SET ${n.join(", ")}`,this._where.length>0){let l=this.buildWhereClause();e+=` WHERE ${l}`;}}else if(this._isDelete){if(e=`DELETE FROM ${this._from}`,this._where.length>0){let n=this.buildWhereClause();e+=` WHERE ${n}`;}}else if(r.currentQuery)e=r.currentQuery;else {if(e=`SELECT ${this._select.join(", ")} FROM ${this._from}`,this._where.length>0){let n=this.buildWhereClause();e+=` WHERE ${n}`;}this._orderBy&&(e+=` ${this._orderBy}`),this._limit!==null&&(e+=` LIMIT ${this._limit}`),this._offset!==null&&(this._limit===null&&(e+=" LIMIT -1"),e+=` OFFSET ${this._offset}`);}let u=r.db.query(e).all(...r.currentParams);return r.reset(),u},t.buildWhereClause=function(){let e=[];for(let s=0;s<this._where.length;s++){let u=this._where[s];u.startsWith("OR ")?(e.push("OR"),e.push(u.substring(3))):(s>0&&!this._where[s-1].startsWith("OR ")&&e.push("AND"),e.push(u));}return e.join(" ")},t.executeOne=function(){let e=this.execute();return e.length>0?e[0]:null},t.executeRaw=function(e,s=[]){return r.db.query(e).all(...s)},t}generateCreateTableSQL(t){let r=[],e=[];for(let u of t.columns){if(!u||typeof u!="object"||!("name"in u)){if(u&&"_type"in u&&u._type==="unique"){let l=u;e.push(`UNIQUE (${l.columns.join(", ")})`);}continue}let n=u,o=`${n.name} ${n.type}`;n.primaryKey&&(o+=" PRIMARY KEY",n.autoIncrement&&(o+=" AUTOINCREMENT")),n.notNull&&!n.primaryKey&&(o+=" NOT NULL"),n.unique&&(o+=" UNIQUE"),n.default!==void 0&&(typeof n.default=="string"?o+=` DEFAULT '${n.default}'`:n.default===null?o+=" DEFAULT NULL":o+=` DEFAULT ${n.default}`),n.references&&(o+=` REFERENCES ${n.references.table}(${n.references.column})`,n.references.options&&(n.references.options.onDelete&&(o+=` ON DELETE ${n.references.options.onDelete}`),n.references.options.onUpdate&&(o+=` ON UPDATE ${n.references.options.onUpdate}`))),r.push(o);}let s=[...r,...e];return `CREATE TABLE IF NOT EXISTS ${t.name} (${s.join(", ")})`}};function c(i,t){return {name:i,columns:t}}function f(i,t){return {name:i,type:t}}function h(i){return {name:i,type:"INTEGER"}}function m(i){return {name:i,type:"TEXT"}}function d(i){return {name:i,type:"REAL"}}function g(i){return {name:i,type:"BLOB"}}function E(i){return {name:i,type:"NUMERIC"}}function _(i,t=false){return {...i,primaryKey:true,autoIncrement:t}}function C(i){return {...i,notNull:true}}function D(i){return Array.isArray(i)?{_type:"unique",columns:i}:{...i,unique:true}}function S(i,t){return {...i,default:t}}function w(i,t,r,e){return {...i,references:{table:t,column:r,options:e}}}function b(i,t,r){return {_type:"index",name:i,columns:Array.isArray(t)?t:[t],unique:r}}exports.DB=a;exports.blob=g;exports.column=f;exports.defaultValue=S;exports.index=b;exports.integer=h;exports.notNull=C;exports.numeric=E;exports.primaryKey=_;exports.real=d;exports.references=w;exports.table=c;exports.text=m;exports.unique=D;//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map